<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Canvas Drag and Drop Test</title>
</head>

<body>
    <section>
        <div>
            <canvas id="canvas" width="300" height="300">
                This text is displayed if your browser does not support HTML5 Canvas.
            </canvas>
        </div>

        <script type="text/javascript">
            var delay = 70;
            var context;
            var canvas;
            var shapes = [];
            var id = 1;
            var WIDTH = 300;
            var HEIGHT = 300;
            var selectedShape;

            function shape(initX, initY) {
                this.x = initX;
                this.y = initY;
                this.isCrossed = false;
                this.id = id;
                id++;
            }

            function rect(shape, w, h) {
                context.beginPath();
                context.rect(shape.x, shape.y, w, h);
                context.closePath();
                context.stroke();
                if (shape.isCrossed) {
                    context.fill();
                }
            }

            function clear() {
                context.clearRect(0, 0, WIDTH, HEIGHT);
            }

            function draw() {
                clear();
                context.fillStyle = "#FF0000";
                rect(new shape(0, 0), WIDTH, HEIGHT);

                shapes.forEach(function (shape) {
                    rect(shape, 30, 30);
                });
            }

            function isClicked(e, shape) {
                return shape.x < e.pageX - canvas.offsetLeft && e.pageX - canvas.offsetLeft < shape.x + 30
                    && shape.y < e.pageY - canvas.offsetTop && e.pageY - canvas.offsetTop < shape.y + 30;
            }

            function move(e) {
                if (selectedShape) {
                    selectedShape.x = e.pageX - canvas.offsetLeft - 15;
                    selectedShape.y = e.pageY - canvas.offsetTop - 15;
                }
            }

            function down(e) {
                shapes.forEach(function (shape) {
                    if (isClicked(e, shape)) {
                        selectedShape = shape;
                        return;
                    }
                });

                if (selectedShape) {
                    selectedShape.x = e.pageX - canvas.offsetLeft - 15;
                    selectedShape.y = e.pageY - canvas.offsetTop - 15;

                    canvas.onmousemove = throttle(move, delay);
                }
            }

            function shapeContainsPoint(shape, x, y) {
                return shape.x <= x && x <= shape.x + 30
                    && shape.y <= y && y <= shape.y + 30
            }

            function isCrossed(currentShape) {
                let flag = false;
                shapes.forEach(function (shape) {
                    if (shape.id != currentShape.id) {
                        if (shapeContainsPoint(shape, currentShape.x, currentShape.y)
                            || shapeContainsPoint(shape, currentShape.x, currentShape.y + 30)
                            || shapeContainsPoint(shape, currentShape.x + 30, currentShape.y)
                            || shapeContainsPoint(shape, currentShape.x + 30, currentShape.y + 30)) {
                            flag = true;
                            return;
                        }
                    }
                });

                return flag;
            }

            function checkForIntersection() {
                shapes.forEach(function (shape) {
                    shape.isCrossed = isCrossed(shape);
                });
            }

            function up() {
                canvas.onmousemove = null;
                selectedShape = null;
                checkForIntersection();
            }

            function init() {
                canvas = document.getElementById("canvas");
                context = canvas.getContext("2d");
                shapes.push(new shape(70, 70));
                shapes.push(new shape(10, 10));
                shapes.push(new shape(10, 10));
                shapes.push(new shape(15, 15));
                return setInterval(draw, delay);
            }


            init();
            canvas.onmousedown = down;
            canvas.onmouseup = up;


            function throttle(func, ms) {

                var isThrottled = false,
                    savedArgs,
                    savedThis;

                function wrapper() {

                    if (isThrottled) {
                        savedArgs = arguments;
                        savedThis = this;
                        return;
                    }

                    func.apply(this, arguments);

                    isThrottled = true;

                    setTimeout(function () {
                        isThrottled = false;
                        if (savedArgs) {
                            wrapper.apply(savedThis, savedArgs);
                            savedArgs = savedThis = null;
                        }
                    }, ms);
                }

                return wrapper;
            }

        </script>
    </section>
</body>

</html>